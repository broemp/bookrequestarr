---
alwaysApply: true
description: Bookrequestarr application architecture and development guidelines
---

# Bookrequestarr - Architecture & Development Guide

## Project Overview
Bookrequestarr is a book request management system similar to Overseerr, built with SvelteKit 2, Svelte 5, TypeScript, and Tailwind CSS 4. It integrates with the Hardcover API for book metadata and supports OIDC authentication.

## Technology Stack

### Frontend
- **Framework**: SvelteKit 2 with Svelte 5 (using runes: `$state`, `$derived`, `$effect`, `$props`)
- **Styling**: Tailwind CSS 4 with custom HSL color variables
- **UI Components**: shadcn-svelte (Button, Card, Input, Badge), custom components
- **State Management**: Svelte 5 runes (no external state management needed)

### Backend
- **Runtime**: Node.js with SvelteKit's built-in server capabilities
- **API Routes**: SvelteKit API routes (`+server.ts`) and server load functions (`+page.server.ts`)
- **Database**: SQLite with Drizzle ORM
- **Authentication**: OIDC (generic provider) with Arctic library, JWT tokens in httpOnly cookies
- **External APIs**: Hardcover GraphQL API for book metadata

### Key Libraries
- `drizzle-orm`: Database ORM
- `arctic`: OIDC authentication
- `jose`: JWT token handling
- `lucide-svelte`: Icon library

## Project Structure

```
bookrequestarr/
├── src/
│   ├── lib/
│   │   ├── components/        # Reusable UI components
│   │   │   ├── ui/           # shadcn-svelte components
│   │   │   ├── LanguageSelect.svelte
│   │   │   └── Toast.svelte
│   │   ├── server/           # Server-side code
│   │   │   ├── db/
│   │   │   │   ├── schema.ts # Drizzle schema definitions
│   │   │   │   └── index.ts  # Database connection
│   │   │   ├── hardcover.ts  # Hardcover API client
│   │   │   ├── auth.ts       # Authentication logic
│   │   │   └── logger.ts     # Structured logging
│   │   ├── stores/           # Client-side stores
│   │   │   └── toast.ts      # Toast notification store
│   │   ├── types/            # TypeScript type definitions
│   │   │   ├── book.ts
│   │   │   ├── request.ts
│   │   │   └── user.ts
│   │   └── utils/            # Utility functions
│   │       └── debounce.ts
│   ├── routes/
│   │   ├── (app)/            # Authenticated routes
│   │   │   ├── dashboard/
│   │   │   ├── search/
│   │   │   ├── requests/
│   │   │   ├── settings/
│   │   │   └── admin/
│   │   ├── api/              # API endpoints
│   │   │   ├── books/
│   │   │   └── requests/
│   │   ├── auth/             # Authentication routes
│   │   └── +layout.svelte    # Root layout
│   ├── hooks.server.ts       # SvelteKit server hooks (auth, dev user)
│   └── app.css               # Global styles
├── docs/                     # Documentation (ALL docs go here)
│   ├── CONFIGURATION.md      # Environment variables and OIDC setup
│   ├── DEPLOYMENT.md         # Docker and production deployment
│   ├── DEVELOPMENT.md        # Local development setup
│   ├── CURSOR_GUIDE.md       # Comprehensive guide for AI assistants
│   └── ROADMAP.md            # Feature roadmap and future plans
├── drizzle/                  # Database migrations
├── data/                     # SQLite database file
├── static/                   # Static assets
└── README.md                 # Main user-facing documentation
```

## Documentation Guidelines

**IMPORTANT**: All documentation files MUST be placed in the `docs/` folder, except for `README.md` which stays in the root as the main entry point.

- **User Documentation**: `README.md` (root), `docs/CONFIGURATION.md`, `docs/DEPLOYMENT.md`
- **Developer Documentation**: `docs/DEVELOPMENT.md`, `docs/CURSOR_GUIDE.md`
- **Project Planning**: `docs/ROADMAP.md`
- **Never** create documentation files in the root directory (except README.md)
- **Always** check if documentation already exists before creating new files

## Database Schema

### Core Tables
- **`users`**: User accounts with OIDC integration
  - Fields: id, oidcId, email, name, role (user/admin), preferredLanguage, createdAt, updatedAt
- **`books`**: Cached book metadata from Hardcover API
  - Fields: id (UUID), hardcoverId (Hardcover API ID), title, author, description, coverImage, isbn, publishDate, language, pages, publisher, rating, ratingCount, cachedAt
- **`requests`**: Book requests from users
  - Fields: id, userId (FK), bookId (FK), preferredLanguage, specialNotes, status (pending/approved/rejected/completed), createdAt, updatedAt
- **`tags`**: Book tags/genres from Hardcover
  - Fields: id, hardcoverTagId, name, category, createdAt
- **`bookTags`**: Junction table for books and tags
  - Fields: id, bookId (FK), tagId (FK), createdAt
- **`api_cache`**: API response cache with TTL
  - Fields: id, requestHash, response, expiresAt, createdAt

### Relationships
- `requests.userId` → `users.id` (CASCADE delete)
- `requests.bookId` → `books.id` (CASCADE delete)
- `bookTags.bookId` → `books.id` (CASCADE delete)
- `bookTags.tagId` → `tags.id` (CASCADE delete)

## Key Features & Implementation Patterns

### 1. Authentication Flow
- OIDC authentication with group-based authorization (`bookrequestarr`, `bookrequestarr_admin`)
- JWT tokens stored in httpOnly cookies
- `DISABLE_AUTH=true` for development (auto-creates `dev-admin` user)
- Auth middleware in `hooks.server.ts` validates tokens and attaches `locals.user`

### 2. Hardcover API Integration
- **Location**: `src/lib/server/hardcover.ts`
- **Pattern**: GraphQL queries with response caching (7-day TTL)
- **Key Functions**:
  - `searchBooks(query, limit)`: Search for books
  - `getBookDetails(hardcoverId)`: Fetch full book details
  - `getTrendingBooks(limit)`: Two-step query (fetch IDs, then details)
  - `getBooksBySeries(seriesId)`: Fetch books in a series
  - `cacheBook(book)`: Store book metadata in local DB
- **Caching Strategy**:
  - API response cache: 7 days (full GraphQL responses)
  - Book metadata cache: Used for request records only
- **Important**: Always use introspection to verify field availability before querying

### 3. Request Management
- Users can request books with preferred language and special notes
- Language-specific duplicate checking (same book, different language = allowed)
- Admin workflow: pending → approved → completed (or rejected)
- "Active" filter shows both pending and approved requests by default

### 4. UI Patterns

#### Modals
- Click outside or press Escape to close
- Body scroll prevention when open
- Accessible with ARIA roles and keyboard handlers

#### Search & Filtering
- Debounced search (300ms)
- Infinite scroll with frontend pagination
- Filters: collections, unreleased, no ebook, unknown authors, non-English
- "Requested" badges on already-requested books

#### Forms
- Client-side submission with `fetch`
- Toast notifications for feedback
- Server-side validation and error handling

### 5. Logging Strategy
- **Location**: `src/lib/server/logger.ts`
- **Levels**: debug, info, warn, error
- **Format**: Structured JSON with timestamps
- **Guidelines**:
  - Log cache hits/misses explicitly
  - Don't log complete request/response bodies
  - Log important state changes and errors
  - Include context (IDs, operation type)

## Development Guidelines

### Adding New Features

#### 1. New API Endpoint
```typescript
// src/routes/api/feature/+server.ts
import { json } from '@sveltejs/kit';
import type { RequestHandler } from './$types';

export const GET: RequestHandler = async ({ locals }) => {
  // Check authentication
  if (!locals.user) {
    return json({ error: 'Unauthorized' }, { status: 401 });
  }
  
  // Your logic here
  return json({ data: result });
};
```

#### 2. New Database Table
1. Update `src/lib/server/db/schema.ts` with Drizzle schema
2. Create migration: `npm run db:generate`
3. Apply migration: `npm run db:migrate` or manually in `drizzle/` folder
4. Update types in `src/lib/types/`

#### 3. New Hardcover API Query
1. Use introspection to verify fields exist
2. Add function to `src/lib/server/hardcover.ts`
3. Use `graphqlQuery()` helper for automatic caching
4. Handle errors gracefully with logging

#### 4. New Page/Route
```typescript
// src/routes/(app)/feature/+page.server.ts
import type { PageServerLoad } from './$types';

export const load: PageServerLoad = async ({ locals }) => {
  // Server-side data loading
  return { data };
};
```

```svelte
<!-- src/routes/(app)/feature/+page.svelte -->
<script lang="ts">
  import type { PageData } from './$types';
  let { data }: { data: PageData } = $props();
  
  // Use Svelte 5 runes
  let state = $state(initialValue);
  let derived = $derived(state * 2);
</script>
```

### Svelte 5 Runes Usage
- `$state()`: Reactive state
- `$derived()`: Computed values
- `$effect()`: Side effects (replaces `onMount` for most cases)
- `$props()`: Component props
- Use `onMount()` from 'svelte' for lifecycle hooks

### Testing Patterns
- **Unit Tests**: Table-driven test structure
- **Integration**: Test API endpoints with real database
- **E2E**: Critical user flows (auth, request creation)

### Code Style
- **Go-style**: Prioritize readability, simplicity, maintainability
- **Error Handling**: Explicit error checks, meaningful messages
- **TypeScript**: Strict mode, avoid `any` where possible
- **Formatting**: Use project's Prettier/ESLint config

## Common Tasks

### Adding a New Book Field
1. Update `HardcoverBook` interface in `src/lib/types/book.ts`
2. Update GraphQL query in `src/lib/server/hardcover.ts`
3. Update `cacheBook()` function to store the field
4. Add migration for database schema change
5. Update UI components to display the field

### Implementing a New Filter
1. Add state in search page: `let filterName = $state(false);`
2. Add UI checkbox/toggle
3. Update `filterUnwantedBooks()` function
4. Apply filter in search results: `if (filterName) { /* filter logic */ }`

### Adding a New Request Status
1. Update `RequestStatus` type in `src/lib/types/request.ts`
2. Update database enum if using constraints
3. Update status badge colors in UI
4. Update admin request management logic

## Environment Variables
```env
# Required
DATABASE_URL=./data/database.db
HARDCOVER_API_KEY=your_api_key

# OIDC (if auth enabled)
OIDC_ISSUER=https://your-provider.com
OIDC_CLIENT_ID=your_client_id
OIDC_CLIENT_SECRET=your_client_secret
OIDC_REDIRECT_URI=http://localhost:5173/auth/callback

# Development
DISABLE_AUTH=true  # Auto-login as admin
NODE_ENV=development

# Optional
API_CACHE_TTL_DAYS=7  # Default: 7
```

## Deployment
- Docker-ready with Node.js adapter
- Works behind reverse proxies (Nginx, Traefik)
- Requires persistent volume for SQLite database
- Environment variables via Docker secrets or `.env`

## Future Enhancements (Planned)
- Automatic downloading integration (Z-Library, Anna's Archive)
- Audiobook support
- Discord/Telegram notifications
- Advanced book metadata (ISBN, series, full tag support)
- User preferences and settings
- Request scheduling and automation

## Troubleshooting

### Hardcover API Errors
1. Check field availability with introspection
2. Verify API key is set and valid
3. Check rate limits and caching
4. Review error logs for GraphQL validation errors

### Database Issues
1. Check migrations are applied: `npm run db:migrate`
2. Verify foreign key constraints
3. Check for locked database (SQLite limitation)
4. Review logs for constraint violations

### Authentication Issues
1. Verify OIDC configuration
2. Check JWT token expiration
3. Ensure group membership for authorization
4. Use `DISABLE_AUTH=true` for local development

## Resources
- [SvelteKit Docs](https://kit.svelte.dev/docs)
- [Svelte 5 Runes](https://svelte.dev/docs/svelte/what-are-runes)
- [Drizzle ORM](https://orm.drizzle.team/docs/overview)
- [Hardcover API](https://hardcover.app/api) (use introspection)
- [Tailwind CSS](https://tailwindcss.com/docs)
